==============================================
Проектное решение по разработке Системы Analog
==============================================

1. Определения, сокращения и аббревиатуры
-----------------------------------------

+--------------+--------------------+------------------------------------+
| Аббревиатура | Термин             | Определение                        |
+==============+====================+====================================+
|              | Сущность           | Тип сведений, хранящихся в Базе    |
|              |                    | данных, имеющих одинаковые по      |
|              |                    | структуре свойства (поля)          |
+--------------+--------------------+------------------------------------+
|              | Экземпляр сущности | Уникально идентифицируемая единица |
|              |                    | сведений, хранящихся в БД,         |
|              |                    | относящаяся к какой-либо из        |
|              |                    | сущностей Системы                  |
+--------------+--------------------+------------------------------------+
| CRUD         | create, read,      | акроним, обозначающий четыре       |
|              | update, delete —   | базовые функции, используемые при  |
|              | «создать, прочесть,| работе с персистентными хранилищами|
|              | обновить, удалить» | данных:                            |
|              |                    |                                    |
|              |                    |   - создание;                      |
|              |                    |   - чтение;                        |
|              |                    |   - редактирование;                |
|              |                    |   - удаление.                      |
+--------------+--------------------+------------------------------------+

2. Общие сведения
-----------------

Система **Analog** служит для подбора аналогов позиций спецификации 
товаров, а также для учета производителей, товаров и т. д.

3. Бизнес-процессы
------------------

**3.1 УЧЕТ ЭКЗЕМПЛЯРОВ СУЩНОСТЕЙ**

:Шаг 1: Пользователь с правами Администратора авторизуется в АРМ Администратора
:Шаг 2: Открывает табличное представление справочника, в который требуется внести изменение
:Шаг 3:
  Внесение изменений:

  1. Пользователь прямо из табличного представления удаляет одну или несколько записей, 
     удаление перемещает запись в архив
  2. Для добавления записи пользователь нажимает соответствующую кнопку в табличном представлении, 
     переходит на страницу карточки экземпляра сущности, заполняет ее и нажимает сохранить
  3. Для редактирования записи, пользователь находит ее в таблице, открывает карточку данной записи, 
     вносит изменения и нажимает кнопку сохранить.

**3.2 ПОДБОР АНАЛОГОВ**

:Шаг 1: Пользователь авторизуется в системе
:Шаг 2: 
  Выбирает пункт меню – загрузить спецификацию. Открывается окно с выбором файла для загрузки. 
  После нажатия ОК, появляется форма, в которой необходимо выбрать производителя, на котором 
  сделана загружаемая спецификация. Производитель выбирается из выпадающего списка. Подтверждается нажатием ОК.
:Шаг 3:
  Внесение параметров подбора: После загрузки спецификации и выбора производителя, 
  появляется окно с формой запроса параметров подбора спецификации-аналога. Форма 
  описана в разделе `6.3 форма запроса параметров подбора спецификации-аналога`_.

Алгоритм поиска замены
  Загруженная спецификация отрабатывается построчно. Каждой строке в выходной спецификации должна 
  соответствовать строка исходной спецификации.

  Для каждого артикула i-той строки исходной спецификации производится поиск записи в БД. 
  В случае, если артикула исходн.спецификации в БД нет – в этой строке выходной спецификации 
  указывается – артикул в БД не найден. 
  
  Если артикул найден, то с учетом данных найденной записи производится поиск записи аналога. 
  Поиск производится с учетом того, что поля Класс, Подкласс должны полностью совпадать с параметрами 
  записи исходной позиции, поле Производитель – с наименованием Производителя выбранном в форме запроса.
  
  Поиск по атрибутам производится последовательно. Т.е. первый атрибут имеет больший приоритет перед последующим. 
  Для жестких атрибутов требуется полное совпадение значений с исходной записью, если иное не указано в форме запроса. 
  Для мягких атрибутов совпадения ищутся исходя параметров по умолчанию, если иное не указано в форме запроса. 
  
  После выбора позиции производится анализ атрибутов Пересчет, Взаимосвязь и Цена. Для атрибута Пересчет должен 
  производится пересчет количества с округлением вверх до целого элемента. 
  
  Выходная спецификация должна быть составлена в тех же ед. измерения, что и входная.

**Блок-схема алгоритма подбора замены:**

.. image:: https://raw.githubusercontent.com/Siyet/analog/master/documentation/source/_static/Алгоритм.jpg

:Шаг 4: Сохранение результатов
  
  После проведения поиска у пользователя запрашивается место для сохранения файла с результатом. 
  Результат сохраняется в формате эксель. Столбцы – номер п/п, артикул, наименование, кол-во, ед.изм.

  В выходной спецификации на каждый элемент исходной спецификации должен быть представлен аналогичный 
  элемент в выходной спецификации (с учетом параметров «взаимосвязь» общее количество элементов может 
  незначительно отличаться). На один элемент исходной спецификации НЕ может быть представлено несколько 
  вариантов в выходной спецификации
  
  Пользователь может определять формат вывода информации – указывать какие столбцы должны быть в «выходной» спецификации.
  
  В БД должны сохраняться все произведенные подборы в формате – «исходная спецификация – выходная 
  спецификация» – с возможностью выгрузки для администратора единой совмещенной таблицы для удобного 
  анализа – что было на входе, что стало на выходе.

4. Декомпозиция архитектуры
---------------------------

4.1 АРМ Пользователя
--------------------
Доступ предоставляется всем пользователям Системы. 

Содержит следующий функционал:

- **Загрузка спецификации и подбор аналогов**

- **Отображение ранее загруженных спецификаций**

- **Настройки пользователя (например, смена пароля)**

4.2 АРМ Администратора
-------------------------
Доступ предоставляется только пользователем с ролью Администратор. 

Включает следующий функционал:

:Функционал прикладного администратора:
  Раздел учета прикладных экземпляров сущностей, касающихся работы со спецификациями и подбора товарных аналогов

:Функционал систменого админисратора:
  Раздел учета пользователей и групп и настройки прав доступа.

  Содержит подразделы **Пользователи** и **Группы**, которые должны быть реализованы в виде представления `6.1 таблица/перечень`_.

  Права доступа могут быть назначены как **Пользователю**, так и **Группе пользователей**.

  По умолчанию должны генериться CRUD-права на каждую из сущностей. Т. е. по четыре разных права (создание, редактирование, просмотр и удаление).

  Перечень дополнительных прав будет выявлен в процессе разработки.

**Пример реализации АРМа Администратора**

.. image:: https://raw.githubusercontent.com/Siyet/analog/master/documentation/source/_static/Админ_панель.png

5. Сущности
-----------

Все нижеописанные сущности должны расширять базовую, содержащую следующие ее поля:

  - Уникальный идентификатор *(системное поле)*
  - Номер ревизии *(системное поле)*
  - Кто создал *(взаимосвязь с Пользователем)*
  - Когда создал *(дата и время)*
  - Кто последний обновил *(взаимосвязь с Пользователем)*
  - Когда обновил *(дата и время)*
  - Опубликовано? *(да/нет)*
  - Признак логического удаления/перемещения в архив *(да/нет)*

Пенречень сущностей:
  - Производитель
  - Класс
  - Подкласс
  - Атрибут
  - Значение атрибута
  - Товар
  - Спецификация
  - Пользователь
  - Группа пользователей

5.1 прикладные сущности
-----------------------

:5.1.1: **Производитель**

  Экземпляром сущности *производитель* является поставщик товаров.

  Удаление экземпляра данной сущности должен отправлять его в архив. В архив 
  также должны быть отправлены все товары данного производителя. Записи 
  архива не участвуют в подборе аналогов.

  Данная сущность носит справочный характер. Предполагается что изменения в перечень её экземпляров будут вноситься редко.

  Поля
    - Наименование
    - Краткое наименование

:5.1.2: **Класс**

  Экземпляром сущности *класс* является крупная товарная категория.

  Данная сущность носит справочный характер. Предполагается что изменения в перечень её экземпляров будут вноситься редко.

  Поля
    - Наименование
    - Краткое наименование
    - Подклассы *(Взаимосвязь с Подклассами)*

:5.1.3: **Подкласс**

  Подгруппа товаров внутри каждого класса, для более удобного поиска и классификации. 
  Внутри одного *Подкласса* каждого *Класса* задействованы одинаковые *Атрибуты* для всех позиций.

  Данная сущность носит справочный характер. Предполагается что изменения в перечень её экземпляров будут вноситься редко.

  Поля
    - Наименование
    - Краткое наименование
    - Принадлежность к классу *(взаимосвязь с Классом)*

:5.1.4: **Атрибут**

  Экземпляром сущности *атрибут* является характеристика *товара*.

  Данная сущность носит справочный характер. Предполагается что изменения в перечень её экземпляров будут вноситься редко.

  Поля
    - Тип *(Жесткий, Мягкий, Пересчет, Взаимосвязь, Цена)*
    - Наименование
    - Приоритет *(Положительное целое число)*
    - Принадлежность к Подклассу *(Взаимосвязь с Подкласс)*
    - Возможные значения *(Взаимосвязь Значение атрибута)*

  *Атрибуты* разделены на типы - *Жесткий*, *Мягкий*, *Пересчет*, *Взаимосвязь*, *Цена*

  При поиске первоочередность атрибута имеет значение. *Пример – атрибут B1 приоритетнее 
  атрибута B2.*

  Жесткий атрибут
    *группа А* – как правило, такой тип жестко определяет подгруппу или свойство 
    товаров, к которой должен относиться подбираемый аналог. Такой параметр 
    жестко определяет важные свойства товара.

    По умолчанию все жесткие атрибуты подбираемого аналога должны в точности 
    соответствовать жестким атрибутам исходной позиции

    *Пример алгоритма: «продукт - кабельный лоток прямая секция, покрытие – холодный цинк, 
    ширина – 500». Все перечисленные атрибуты должны в точности совпадать с подбираемым аналогом.*

  Мягкий Атрибут
    *группа B* – как правило, такой тип имеет незначительную вариативность 
    конкретного свойства товара у разных производителей. Как правило, 
    отличия этих свойства не являются определяющими и критическими, однако 
    требуют уточнения для нахождения аналога в процессе поиска. Также такой 
    тип параметра требует уточнения принципа поиска, который задается при 
    формировании запроса на подбор аналогов.  

    *Пример алгоритма подбора - Мягкий атрибут для продукта каб.лоток прямая секция – 
    «толщина – 0,8мм, высота борта – 50мм». При наличии нескольких вариантов выбора (т.е. все 
    жесткие атрибуты совпадают), необходимо осуществлять подбор с учетом расширенных – мягких атрибутов.*

    По умолчанию – подбирается позиция с наиболее арифметически близким значением. 

    При условии указаний пользовательских критериев поиска  - критерии задаются в форме запроса. 
    Примеры критериев подбора для параметра «толщина»: не более, чем … мм, выбрать минимальный 
    из имеющихся, выбрать максимальный из имеющихся, выбрать наиболее близкий к исходному.

  Атрибут Пересчет
    *группа C* – подобранный элемент-аналог может совпадать по всем заданным 
    параметрам, однако иметь другой размер. Например, длина исходной секции – 3000мм, а длина 
    подобранного и полностью подходящего по всем параметрам аналога составляет 2000мм. В этом случае, 
    необходимо соответствующим образом, пересчитать количество товара в «выходной» спецификации.

    *Пример алгоритм подбора параметра Пересчет - в исходной спецификации количество может быть 
    задано как в штуках, так и в метрах. Если задано в метрах – пересчитывать не нужно. Если задано 
    в штуках, то необходимо:*
    
      1. *Уточнить – есть ли разница в длине кабельных лотков – исходного и подбираемого.*
      2. *Если разница есть, то перевести исходное кол-во в метры, а затем метры поделить 
         на длину подбираемого лотка, округлить в большую сторону.*

  Атрибут Взаимосвязь
    – определяет наличие взаимосвязей между элементами. 
    
    *Например, для крепления крышки у одного производителя не требуется допоплнительных элементов, а у другого необходимы клипсы.*

  Атрибут Цена
    – содержит стоимость товара.

  **Пример**

+---------------------------------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                             | атрибуты                                                                                                                                                   |
+---------------------------------------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
|                                             | А1        | А2        | А3         | А4                 | А5       | B1          | B2               | C1       | C2          | D1                 | E1     |
+---------------------------------------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
|                                             | тип атрибута                                                                                                                                               |
+---------------------------------------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
| ключевые параметры записи                   | жесткий   | жесткий   | жесткий    | жесткий            | жесткий  | мягкий      | мягкий           | пересчет | пересчет    | взаимосвязь        | цена 1 |
+---------------------------------------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
|                                             | пользовательское название артибута для конкретного класса                                                                                                  |
+-------+------------+--------+---------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
| класс | подкласс   | арт    | производитель | вид       | покрытие  | ширина, мм | резерв             | резерв   | толщина, мм | высота борта, мм | длина,мм | ед.изм.     | крепление          | руб.   |
+-------+------------+--------+---------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
| КНС   | прямая     | 101010 | А             | перф.     | сендзимир | 200        |                    |          | 0,8         | 80               | 3000     | штуки/метры | компл.соединителя, |        |
|       | секция     |        |               |           |           |            |                    |          |             |                  |          |             | 1шт, арт ХХХ       |        |
+-------+------------+--------+---------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
| класс | подкласс   | арт    | производитель | вид       | проводник | номинал, А | кол-во проводников | класс IP | корпус      | резерв           | длина,мм | штуки/метры | резерв             | руб.   |
+-------+------------+--------+---------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+
| ШП    | поворотный | 40932  | ХХ            | распреде- | Алюм.     | 2000А      | 4                  | IP55     | сталь       |                  |          |             |                    |        |
|       | модуль     |        |               | лительный |           |            |                    |          |             |                  |          |             |                    |        |
+-------+------------+--------+---------------+-----------+-----------+------------+--------------------+----------+-------------+------------------+----------+-------------+--------------------+--------+



:5.1.5: **Значение атрибута**

  Экземпляр сущности *значение атрибута* представляет собой значение одного 
  атрибута одного из товаров.

  Данная сущность является рабочей. Предполагаются частые изменения перечня её экземпляров.

  Поля
    - Значение
    - Принадлежность к атрибуту *(Взаимосвязь с Атрибут)*
    - Принадлежность к товару *(Взаимосвязь с Товаром)*

:5.1.6: **Товар**

  Экземпляр сущности *товар* принадлежит какому-либо *производителю* и только одному.

  Удаление экземпляра данной сущности должен отправлять его в архив. Записи 
  архива не участвуют в подборе аналогов.

  Данная сущность является рабочей. Предполагаются частые изменения перечня её экземпляров.

  Поля
    - Принадлежность к Подклассу *(Взаимосвязь с Подкласс)*
    - Значения атрибутов *(Взаимосвязь Значение атрибута)*
    - Производитель *(Взаимосвязь с Производителем)*
    - Артикул *У каждой позиции внутри одного производителя есть уникальный артикул. Артикулы разных производителей, теоретически могут иметь повторения.*

:5.1.7: **Спецификация**

  Экземпляр сущности *спецификация* представляет собой загружаемую группу товаров с целью поиска их аналогов.

  *Спецификация* является основной рабочей сущностью. Предполагаются очень частые изменения перечня её экземпляров.

  Поля
    - Наименование
    - Позиции (товары) *(Взаимосвязь с Товарами)*

5.2 Системные сущности
----------------------

:5.2.1: **Пользователь**

  Данная сущность носит системный характер. Предполагается что изменения в перечень её экземпляров будут вноситься редко.

  Поля
    - Имя пользователя
    - Принадлежность к группам *(Взаимосвязь с Группами)*
    - Электронная почта
    - Логин
    - Пароль

:5.2.2: **Группы пользователей**

  Данная сущность носит системный характер. Предполагается что изменения в перечень её экземпляров будут вноситься очень редко.

  Поля
    - Наименование
    - Права

6. Представления
----------------

6.1 таблица/перечень
--------------------

Представляет собой страницу Системы с размещенной на ней таблицей с данными.

Данное представление должно предусматривать:

- Прямую и обратную сортировку по одной или нескольким колонок. 
  На случай сортировки по нескольким колонкам должна быть предсмотрена 
  возможность выставления приоритета сортировки.
- Фильтрацию по заранее определнным колонкам. Фильтрация по колонке может быть представлена в виде поиска:
  - поиска по колонке;
  - в виде выбора значения из справочника;
  - выбор заранее определенного диапозона значений;
  - иные фильтры четко описанные в разделе `5. Сущности`_.
- Возможность применения действия (например, отправка в архив) к нескольким 
  записям одновременно.
- Отображение общего количества записей в данной таблице.
- При большом количестве строк - разбиение на страницы.
- Импорт данных из XLS. При импорте в обязательном порядке должны осуществляться проверка на корректность импортируемых сведений и устранение задвоений.
- Экспорт данных в XLS.

.. image:: https://raw.githubusercontent.com/Siyet/analog/master/documentation/source/_static/Табличное_представление.jpg

6.2 карточка экземпляра сущности
--------------------------------

Представляет собой страницу Системы с размещенной на ней информацией о создаваемом или существующем экземпляре сущности.

Данное представление должно предусматривать возможность редактирования каждого из полей экземпляра сущности, доступного для редактирования.

.. image:: https://raw.githubusercontent.com/Siyet/analog/master/documentation/source/_static/Карточка_экземпляра.jpg

Здесь же должна быть отображена информация об истории изменения данного экземпляра сущности.

.. image:: https://raw.githubusercontent.com/Siyet/analog/master/documentation/source/_static/История.jpg

6.3 форма запроса параметров подбора спецификации-аналога
---------------------------------------------------------

Форма состоит из трех частей.
  
:Первая часть: «автоматический подбор»

  Из выпадающего списка выбирается производитель, 
  на котором будет сделана исходящая спецификация. Внизу формы две кнопки – Атрибуты и ОК. 
  При выборе ОК – начинается подбор. Атрибуты – расширение формы вниз.

:Вторая часть: Форма динамическая! В этой части формы – 
  перечень «мягких» атрибутов для каждого класса. Напротив каждого атрибута – 
  значение по умолчанию с выпадающим списком возможных вариантов выбора. 
  В форму выбираются только те атрибуты тех классов, товары которых есть во входной спецификации. 
  «Лишние» классы и атрибуты  выводиться в форме не должны. Возможно разделение по классам для простоты понимания.

  Галочка к атрибуту «пересчет»

  Внизу также кнопки – Доп.атрибуты и ОК. при выборе ОК – начинается подбор. 

  Доп.Атрибуты – еще расширение формы вниз. 

:Третья часть: В этой части формы – 
  перечень «жестких» атрибутов для каждого класса. Форма также динамическая. Напротив каждого атрибута – 
  значение по умолчанию с выпадающим списком возможных вариантов выбора.

7. Группы
---------

:Администратор: 
  - Пользователь, имеющий CRUD права на все сущности и их экземпляры
  - Пользователь, имеющий read права на все сущности и их экземпляры

:Менеджер: (клиент Системы)

  - Пользователь, имеющий права на загрузку спецификаций, получение результата и редактирование.
  - Пользователь, имеющий права только на загрузку спецификаций и получение результата, без возможности редактирования.

8. Справочники и классификаторы
-------------------------------

Нижеописанные записи в справочниках, являются примерами, полный перечень справочников 
и записей в них будет выявлен в процессе разработки.

:Производители:
  - A
  - XX

:Классы:
  - ШП
  - КНС

:Подклассы:
  - Поворотный модуль *(класс - ШП)*
  - Прямая секция *(класс - КНС)*

:Атрибуты:
  A. Жесткие *(вид - КНС/Прямая секция)*

    1. Вид
    2. Покрытие
    3. Ширина, мм
    
  B. Мягкие *(вид - КНС/Прямая секция)*
    
    1. Толщина, мм
    2. Высота борта, мм

  C. Пересчет *(вид - КНС/Прямая секция)*

    1. Длина, мм

  D. Взаимосвязь *(вид - КНС/Прямая секция)*

    1. Крепление

  E. Цена *(вид - КНС/Прямая секция)*

    1. руб.

  A. Жесткие *(вид - ШП/Поворотный модуль)*

    1. Вид
    2. Проводник
    3. Номинал, А
    4. Количество проводников

  B. Мягкие *(вид - ШП/Поворотный модуль)*

    1. Корпус

  C. Пересчет *(вид - ШП/Поворотный модуль)*

    1. Длина, мм

  E. Цена *(вид - ШП/Поворотный модуль)*

    1. руб.

:Типы атрибутов:
  - Жесткий
  - Мягкий
  - Пересчет
  - Взаимосвязь
  - Цена

9. Требования к отказоустойчивости
----------------------------------

Требуется выполнять резервное копирование БД 1 раз в сутки в ночное время.

Дополнительно требуется настроить Журнал Опережающей Записи (WAL). 
Предусмотреть возможность восстановление БД из логов WAL в случае отказа Системы.

10. Требования к хостингу и инфраструктура хостинга
---------------------------------------------------

Реализация проекта предполагается на технологиях:

- CentOS, Debian, ArchLinux (latest stable)
- Python 3.7
- Django 2.1
- PostgreSQL 12
- Git (latest stable)
- Nginx (latest stable)
- Nginx Unit (latest stable)
- Pip (latest stable)

Допускается использование Виртуального хостинга, VPS, либо Выделенного сервера при условии наличия возможности установки на них вышеуказанных технологий.

Хостинг также должен иметь поключение к сети Интернет и белый IP-адрес

Общедоступное публичное доменное имя не требуется.

